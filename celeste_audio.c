/**
 * This code is basically a convertion of fake-08 sound and music emulation
 * converted to C, with custom instruments support removed and some optimizations
 * for running on low power devices
 */

#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <stdbool.h>
#include <float.h>

#define SAMPLE_RATE 22050

#define MAX_SFX 64
#define BYTES_PER_SFX 68

#define MAX_MUSIC 64
#define BYTES_PER_MUSIC 4


enum
{
    FX_NO_EFFECT = 0,
    FX_SLIDE =     1,
    FX_VIBRATO =   2,
    FX_DROP =      3,
    FX_FADE_IN =   4,
    FX_FADE_OUT =  5,
    FX_ARP_FAST =  6,
    FX_ARP_SLOW =  7,
};

struct musicChannel {
    int16_t count;
    int16_t pattern;
    int8_t master;
    uint8_t mask;
    uint8_t speed;
    float volume;
    float volume_step;
    float offset;
    uint8_t length;
};

struct noteChannel {
    float phi;
    uint8_t note[2];
};

struct sfxChannel {
    int16_t sfxId;
    float offset;
    bool can_loop;
    bool is_music;
    struct noteChannel current_note;
    struct noteChannel prev_note;
};

struct audioState_t {
    struct musicChannel _musicChannel;
    struct sfxChannel _sfxChannels[4];
};

struct sfx {
    union
    {
        struct 
        {
            uint8_t notes[32][2];

            uint8_t editorMode;
            uint8_t speed;
            uint8_t loopRangeStart;
            uint8_t loopRangeEnd;
        };

        uint8_t data[BYTES_PER_SFX];
    };
};

static float getWaveformSample(int instrument, float advance);
static float getSampleForNote(struct noteChannel *channel, struct sfxChannel *parentChannel, uint8_t prev_note[2], float freqShift, bool forceRemainder);
static float getSampleForSfx(struct sfxChannel *channel, float freqShift);
static void set_music_pattern(int pattern);
static int16_t getSampleForChannel(int channel);


static float lerp(float a, float b, float t) {
    return (b - a) * t + a;
}

static int max(int a, int b) {
    return (a > b) ? a : b;
}

static float clamp (float val, float lo, float hi) {
    val = (val > hi) ? hi : val;
    return (val < lo) ? lo : val;
}

#ifdef CELESTE_SLOW_CPU
static const float keyTable[64] = {
    65.406395, 69.295654, 73.416199, 77.781746, 82.406883, 87.307060, 92.498604, 97.998856,
    103.826180, 110.000000, 116.540947, 123.470825, 130.812790, 138.591324, 146.832382, 155.563492,
    164.813782, 174.614105, 184.997208, 195.997726, 207.652344, 220.000000, 233.081879, 246.941650,
    261.625580, 277.182617, 293.664764, 311.126984, 329.627563, 349.228241, 369.994415, 391.995422,
    415.304688, 440.000000, 466.163757, 493.883301, 523.251160, 554.365295, 587.329529, 622.253967,
    659.255127, 698.456482, 739.988831, 783.990845, 830.609436, 880.000000, 932.327576, 987.766602,
    1046.502319, 1108.730591, 1174.659058, 1244.507935, 1318.510254, 1396.912842, 1479.977661, 1567.981812,
    1661.218750, 1760.000000, 1864.654907, 1975.533325, 2093.004639, 2217.460938, 2349.318359, 2489.015869
};

static float key_to_freq(int key)
{
    return keyTable[key];
}
#else
static float key_to_freq(int key)
{
    return 440.f * exp2((key - 33.f) / 12.f);
}
#endif

static struct audioState_t _audioState;

static uint8_t mem_songs[MAX_MUSIC][BYTES_PER_MUSIC] = {
    { 0x95, 0x0a, 0x56, 0x44 },
    { 0x0a, 0x16, 0x0c, 0x44 },
    { 0x0a, 0x16, 0x0c, 0x44 },
    { 0x0a, 0x0b, 0x0c, 0x44 },
    { 0x14, 0x13, 0x12, 0x44 },
    { 0x0a, 0x16, 0x0c, 0x44 },
    { 0x0a, 0x16, 0x0c, 0x44 },
    { 0x0a, 0x91, 0x12, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x98, 0x19, 0x1a, 0x44 },
    { 0x18, 0x19, 0x1a, 0x44 },
    { 0x1c, 0x1b, 0x1a, 0x44 },
    { 0x1d, 0x1b, 0x1a, 0x44 },
    { 0x1f, 0x21, 0x1a, 0x44 },
    { 0x1f, 0x1a, 0x21, 0x44 },
    { 0x1e, 0x1a, 0x22, 0x44 },
    { 0x20, 0x9a, 0x24, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0xaa, 0x27, 0x29, 0x44 },
    { 0x2a, 0x27, 0x29, 0x44 },
    { 0x2f, 0x2b, 0x29, 0x44 },
    { 0x2f, 0x2b, 0x2c, 0x44 },
    { 0x2f, 0x2b, 0x29, 0x44 },
    { 0x2f, 0x2b, 0x2c, 0x44 },
    { 0x2e, 0x2d, 0x30, 0x44 },
    { 0x34, 0x31, 0x27, 0x44 },
    { 0x35, 0xb2, 0x27, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0xbd, 0x7e, 0x43, 0x44 },
    { 0x3d, 0x7e, 0x43, 0x44 },
    { 0x3d, 0x4a, 0x43, 0x44 },
    { 0x3d, 0xbe, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0xb8, 0x3a, 0x3c, 0x44 },
    { 0x39, 0xbb, 0x3c, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
    { 0x41, 0x42, 0x43, 0x44 },
};

static struct sfx mem_sfx[MAX_SFX] = {
    { .data = { 0xf6, 0x0e, 0x23, 0x0f, 0xef, 0x0e, 0x1d, 0x0f, 0xea, 0x0e, 0x17, 0x0f, 0xe7, 0x0e, 0x13, 0x0f, 0xe3, 0x0e, 0x11, 0x0f, 0xde, 0x0e, 0x0e, 0x0f, 0xda, 0x0c, 0x0c, 0x0d, 0xd6, 0x0a, 0x08, 0x09, 0xd2, 0x06, 0x05, 0x05, 0x99, 0x01, 0x99, 0x01, 0x99, 0x01, 0x99, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0x00, 0x02, 0x00, 0x00 } },
    { .data = { 0x11, 0x0e, 0x13, 0x0e, 0x1a, 0x0e, 0x24, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00 } },
    { .data = { 0x0d, 0x0e, 0x10, 0x0e, 0x16, 0x0e, 0x22, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00 } },
    { .data = { 0x06, 0x05, 0x08, 0x05, 0x09, 0x05, 0x0b, 0x05, 0x22, 0x09, 0x2a, 0x0b, 0xbc, 0x0b, 0xbb, 0x0b, 0xbb, 0x0b, 0xb9, 0x0b, 0xb6, 0x0b, 0xb2, 0x0b, 0xad, 0x0b, 0xa8, 0x0b, 0xa4, 0x09, 0xa1, 0x09, 0x9d, 0x09, 0x9a, 0x09, 0x96, 0x07, 0x91, 0x07, 0x8e, 0x07, 0x8b, 0x05, 0x87, 0x05, 0x85, 0x03, 0x83, 0x03, 0x90, 0x01, 0x90, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x00, 0x02, 0x00, 0x00 } },
    { .data = { 0x0f, 0x0e, 0x1e, 0x0e, 0x12, 0x0e, 0x22, 0x0e, 0x17, 0x0e, 0x26, 0x0e, 0x1b, 0x0c, 0x2c, 0x0c, 0x21, 0x0a, 0x31, 0x0a, 0x27, 0x08, 0x36, 0x08, 0x2b, 0x06, 0x3a, 0x06, 0x30, 0x04, 0x3e, 0x04, 0x35, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00 } },
    { .data = { 0xc9, 0x0f, 0xc9, 0x0f, 0xc9, 0x0d, 0xc9, 0x0b, 0xc8, 0x09, 0xc7, 0x07, 0xc6, 0x05, 0xc5, 0x53, 0xf5, 0x01, 0xf4, 0x01, 0xf4, 0x01, 0xf4, 0x01, 0xf4, 0x01, 0xf4, 0x01, 0xf4, 0x01, 0xf5, 0x01, 0xf5, 0x01, 0xf5, 0x01, 0xf5, 0x01, 0xf5, 0x01, 0xf4, 0x01, 0xf4, 0x01, 0xf4, 0x01, 0xf3, 0x01, 0xf3, 0x01, 0xf3, 0x01, 0xf3, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0x00, 0x03, 0x00, 0x00 } },
    { .data = { 0x64, 0x0e, 0x4e, 0x0e, 0x6d, 0x0e, 0x56, 0x0e, 0x74, 0x0e, 0x60, 0x0c, 0x7b, 0x0c, 0x68, 0x0a, 0x7f, 0x08, 0x6f, 0x04, 0x68, 0x02, 0x5d, 0x02, 0x50, 0x02, 0x43, 0x02, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x00, 0x03, 0x00, 0x00 } },
    { .data = { 0x50, 0x02, 0x52, 0x02, 0x54, 0x02, 0x56, 0x02, 0x5a, 0x04, 0x60, 0x04, 0x66, 0x06, 0x72, 0x08, 0x72, 0x08, 0x74, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x00, 0x02, 0x00, 0x00 } },
    { .data = { 0x07, 0x0e, 0x0a, 0x0e, 0x0e, 0x0e, 0x10, 0x0e, 0x16, 0x0e, 0x22, 0x0e, 0x2f, 0x0e, 0x2f, 0x0c, 0x2c, 0x0c, 0x2c, 0x0a, 0x2f, 0x0a, 0x2f, 0x08, 0x2c, 0x08, 0x2c, 0x06, 0x2f, 0x04, 0x2f, 0x02, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00 } },
    { .data = { 0x45, 0x02, 0x47, 0x06, 0xbf, 0x09, 0xbf, 0x09, 0xbf, 0x07, 0xbf, 0x05, 0xbf, 0x03, 0xbf, 0x53, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x00, 0x03, 0x00, 0x00 } },
    { .data = { 0xc1, 0x5f, 0x80, 0x51, 0xc1, 0x5f, 0xc1, 0x51, 0xa3, 0x5b, 0xc1, 0x5f, 0x81, 0x51, 0x80, 0x51, 0xc1, 0x5f, 0x80, 0x51, 0xc1, 0x51, 0x87, 0x51, 0xa3, 0x5b, 0x80, 0x51, 0xc1, 0x5f, 0x80, 0x51, 0xc1, 0x5f, 0xc1, 0x51, 0xc1, 0x5f, 0x80, 0x51, 0xa3, 0x5b, 0xc1, 0x5f, 0x81, 0x51, 0x80, 0x51, 0xc1, 0x5f, 0x80, 0x51, 0xa5, 0x51, 0x81, 0x51, 0xa3, 0x5b, 0xa5, 0x51, 0xc1, 0x5f, 0xa3, 0x5b, 0x01, 0x10, 0x00, 0x20 } },
    { .data = { 0x1d, 0x08, 0x1d, 0x08, 0x1d, 0x06, 0x1d, 0x04, 0x18, 0x08, 0x18, 0x08, 0x18, 0x06, 0x18, 0x04, 0x1b, 0x06, 0x1b, 0x04, 0x22, 0x08, 0x22, 0x68, 0x1f, 0x56, 0x1f, 0x06, 0x16, 0x08, 0x16, 0x08, 0x1d, 0x08, 0x1d, 0x08, 0x1d, 0x20, 0x13, 0x1c, 0x18, 0x06, 0x18, 0x06, 0x18, 0x20, 0x1f, 0x1c, 0x24, 0x0a, 0x22, 0x04, 0x16, 0x08, 0x13, 0x04, 0x1d, 0x08, 0x1b, 0x24, 0x18, 0x08, 0x18, 0x08, 0x00, 0x20, 0x00, 0x00 } },
    { .data = { 0x07, 0x0e, 0x07, 0x0c, 0x07, 0x0a, 0x11, 0x00, 0x07, 0x0e, 0x07, 0x0c, 0x03, 0x1a, 0x0f, 0x0e, 0x0a, 0x0e, 0x0a, 0x0c, 0x0a, 0x0a, 0x0a, 0x00, 0x0a, 0x0e, 0x0a, 0x0c, 0x05, 0x0a, 0x05, 0x08, 0x03, 0x0e, 0x03, 0x0c, 0x03, 0x00, 0x03, 0x0a, 0x0c, 0x0e, 0x0c, 0x0c, 0x11, 0x0a, 0x16, 0x0e, 0x16, 0x0c, 0x0f, 0x1e, 0x05, 0x0a, 0x0a, 0x0e, 0x05, 0x0a, 0x03, 0x1a, 0x0a, 0x0e, 0x0a, 0x0c, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0x4c, 0x0b, 0x5c, 0x0d, 0x50, 0x0f, 0x63, 0x0f, 0x59, 0x0f, 0x6c, 0x0f, 0x61, 0x0f, 0x77, 0x0f, 0x68, 0x0f, 0x7b, 0x0f, 0x6c, 0x0f, 0x7e, 0x0d, 0x71, 0x0b, 0x7e, 0x09, 0x71, 0x07, 0x7e, 0x07, 0x71, 0x05, 0x7f, 0x05, 0x71, 0x05, 0x7f, 0x05, 0x71, 0x03, 0x7f, 0x03, 0x71, 0x03, 0x7f, 0x03, 0x71, 0x03, 0x7f, 0x03, 0x71, 0x03, 0x7f, 0x01, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01, 0x40, 0x01, 0x00, 0x04, 0x00, 0x00 } },
    { .data = { 0xef, 0x09, 0xeb, 0x0d, 0xe6, 0x0f, 0xdd, 0x0f, 0xd5, 0x0f, 0xd5, 0x0f, 0xd9, 0x0f, 0xdc, 0x0b, 0xd7, 0x07, 0xc1, 0x01, 0xd5, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0x00, 0x04, 0x00, 0x00 } },
    { .data = { 0x89, 0x59, 0x8e, 0x5b, 0x86, 0x5b, 0x8a, 0x5b, 0x8d, 0x5b, 0x85, 0x5b, 0x91, 0x5b, 0x87, 0x5b, 0x8c, 0x5b, 0x84, 0x5b, 0x89, 0x5b, 0x91, 0x59, 0x88, 0x57, 0x8d, 0x53, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x80, 0x51, 0x00, 0x03, 0x00, 0x00 } },
    { .data = { 0xdf, 0x5e, 0xd8, 0x5e, 0xe7, 0x5e, 0xe7, 0x00, 0xe7, 0x00, 0xe4, 0x00, 0xdd, 0x00, 0xe6, 0x00, 0xea, 0x00, 0xdc, 0x00, 0xd9, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0x01, 0x10, 0x00, 0x00 } },
    { .data = { 0x69, 0x47, 0x69, 0x4b, 0x69, 0x4f, 0x5d, 0x09, 0x62, 0x0f, 0x62, 0x0d, 0x58, 0x0f, 0x58, 0x0f, 0x58, 0x0d, 0x58, 0x01, 0x58, 0x0f, 0x58, 0x0d, 0x40, 0x01, 0x56, 0x0f, 0x56, 0x2f, 0x56, 0x2d, 0x67, 0x43, 0x67, 0x47, 0x67, 0x4b, 0x67, 0x4f, 0x5f, 0x0f, 0x5f, 0x0d, 0x5f, 0x01, 0x53, 0x05, 0x5b, 0x1b, 0x75, 0x07, 0x70, 0x0d, 0x64, 0x09, 0x69, 0x0f, 0x69, 0x0d, 0x62, 0x0f, 0x62, 0x0d, 0x01, 0x10, 0x00, 0x00 } },
    { .data = { 0x0a, 0x0e, 0x0a, 0x0a, 0x0f, 0x1e, 0x0f, 0x0a, 0x0a, 0x0c, 0x0a, 0x08, 0x11, 0x0e, 0x11, 0x0a, 0x07, 0x00, 0x07, 0x00, 0x11, 0x0e, 0x11, 0x0a, 0x07, 0x0c, 0x07, 0x08, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x0e, 0x0a, 0x0a, 0x0f, 0x0e, 0x0f, 0x0a, 0x0a, 0x0c, 0x0a, 0x08, 0x13, 0x1e, 0x13, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x13, 0x0e, 0x13, 0x0a, 0x0f, 0x0e, 0x0f, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x00, 0x20 } },
    { .data = { 0x22, 0x08, 0x22, 0x06, 0x22, 0x04, 0x1b, 0x12, 0x24, 0x08, 0x24, 0x06, 0x27, 0x0a, 0x1f, 0x04, 0x2b, 0x08, 0x22, 0x04, 0x27, 0x0a, 0x22, 0x04, 0x29, 0x08, 0x29, 0x06, 0x29, 0x04, 0x16, 0x02, 0x22, 0x08, 0x22, 0x06, 0x2b, 0x08, 0x1b, 0x06, 0x24, 0x28, 0x24, 0x26, 0x27, 0x08, 0x18, 0x06, 0x1d, 0x08, 0x1d, 0x06, 0x1f, 0x2a, 0x1f, 0x28, 0x1f, 0x06, 0x1d, 0x14, 0x1d, 0x08, 0x1d, 0x06, 0x00, 0x20, 0x00, 0x00 } },
    { .data = { 0xc1, 0x0f, 0xc1, 0x5f, 0xbf, 0x55, 0xbb, 0x01, 0xbc, 0x01, 0xbb, 0x01, 0xbf, 0x55, 0xb1, 0x01, 0xa3, 0x0b, 0xa3, 0x5b, 0xbc, 0x01, 0x00, 0x00, 0xbf, 0x55, 0x00, 0x00, 0xc1, 0x5f, 0xc1, 0x01, 0xc1, 0x0f, 0xc1, 0x5f, 0xbf, 0x01, 0xbf, 0x01, 0xbf, 0x55, 0x00, 0x00, 0xbf, 0x55, 0x00, 0x00, 0xa3, 0x0b, 0xa3, 0x5b, 0x00, 0x00, 0x00, 0x00, 0xbf, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x08, 0x00, 0x20 } },
    { .data = { 0x4a, 0x08, 0x4a, 0x06, 0x4a, 0x04, 0x51, 0x06, 0x51, 0x04, 0x51, 0x02, 0x5b, 0x08, 0x5b, 0x06, 0x58, 0x2a, 0x58, 0x28, 0x58, 0x26, 0x53, 0x08, 0x53, 0x08, 0x53, 0x06, 0x53, 0x04, 0x53, 0x02, 0x4f, 0x08, 0x4f, 0x06, 0x4f, 0x04, 0x51, 0x06, 0x51, 0x04, 0x51, 0x02, 0x56, 0x28, 0x56, 0x26, 0x53, 0x0a, 0x53, 0x08, 0x53, 0x06, 0x53, 0x04, 0x53, 0x02, 0x53, 0x02, 0x53, 0x02, 0x53, 0x00, 0x00, 0x20, 0x00, 0x20 } },
    { .data = { 0xee, 0x0b, 0xf7, 0x0b, 0xee, 0x07, 0xf7, 0x07, 0xee, 0x05, 0xf7, 0x05, 0xee, 0x03, 0xf7, 0x03, 0xe2, 0x0b, 0xeb, 0x0b, 0xe2, 0x07, 0xeb, 0x07, 0xdd, 0x0b, 0xe4, 0x0b, 0xdd, 0x07, 0xe4, 0x07, 0xdf, 0x0b, 0xe7, 0x0b, 0xdf, 0x07, 0xe7, 0x07, 0xdf, 0x05, 0xe7, 0x05, 0xe9, 0x0b, 0xf0, 0x0b, 0xe9, 0x07, 0xf0, 0x07, 0xe9, 0x05, 0xf0, 0x05, 0xe9, 0x03, 0xf0, 0x03, 0xe9, 0x03, 0xf0, 0x03, 0x00, 0x10, 0x00, 0x20 } },
    { .data = { 0xd8, 0x0f, 0xf5, 0x0f, 0xf5, 0x0f, 0xf5, 0x0d, 0xf5, 0x0b, 0xf5, 0x09, 0xf5, 0x07, 0xf5, 0x05, 0xf5, 0x03, 0xf5, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0x00, 0x06, 0x00, 0x00 } },
    { .data = { 0x29, 0x0b, 0xf5, 0x03, 0x29, 0x09, 0xf5, 0x03, 0x29, 0x07, 0xf7, 0x03, 0x29, 0x05, 0xf7, 0x03, 0x22, 0x0b, 0xf5, 0x03, 0x22, 0x09, 0x27, 0x0b, 0xfc, 0x03, 0x27, 0x09, 0xfc, 0x03, 0x27, 0x05, 0x2e, 0x0b, 0xf5, 0x03, 0x2e, 0x09, 0xf5, 0x03, 0x2e, 0x07, 0xf7, 0x03, 0x2e, 0x05, 0xf7, 0x03, 0x2e, 0x03, 0x24, 0x09, 0x2b, 0x0b, 0xf5, 0x03, 0x29, 0x0b, 0xfc, 0x03, 0x29, 0x09, 0xfc, 0x03, 0x00, 0x18, 0x00, 0x20 } },
    { .data = { 0x45, 0x0f, 0x45, 0x0f, 0x45, 0x0f, 0x45, 0x0f, 0x45, 0x0f, 0x00, 0x00, 0x45, 0x0f, 0x47, 0x0f, 0x4a, 0x0f, 0x4a, 0x0f, 0x4a, 0x0f, 0x00, 0x00, 0x4a, 0x0f, 0x00, 0x00, 0x4a, 0x0f, 0x43, 0x0f, 0x45, 0x0f, 0x45, 0x0f, 0x45, 0x0f, 0x00, 0x00, 0x45, 0x0f, 0x45, 0x0f, 0x45, 0x0f, 0x00, 0x00, 0x4a, 0x0f, 0x47, 0x0f, 0x4c, 0x0f, 0x4c, 0x0f, 0x4f, 0x0f, 0x00, 0x00, 0x4a, 0x0f, 0x47, 0x0f, 0x00, 0x18, 0x00, 0x20 } },
    { .data = { 0xbb, 0x57, 0xae, 0x01, 0xbb, 0x55, 0x00, 0x00, 0xbb, 0x53, 0x00, 0x00, 0x00, 0x00, 0xb3, 0x01, 0xb3, 0x09, 0xb3, 0x07, 0xb3, 0x05, 0xb3, 0x03, 0xb3, 0x03, 0xbf, 0x01, 0xbf, 0x53, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0c, 0x00, 0x10 } },
    { .data = { 0x24, 0x0b, 0xf0, 0x03, 0x2b, 0x0b, 0xf0, 0x03, 0x24, 0x09, 0xf0, 0x01, 0x2b, 0x09, 0xf7, 0x01, 0x24, 0x05, 0xfa, 0x03, 0x2b, 0x05, 0xfa, 0x03, 0x24, 0x03, 0xf5, 0x03, 0x2b, 0x03, 0xf5, 0x03, 0x1d, 0x0b, 0xf3, 0x03, 0x24, 0x0b, 0xfc, 0x03, 0x1d, 0x09, 0xf7, 0x03, 0x24, 0x09, 0xf3, 0x01, 0x1d, 0x05, 0xf5, 0x01, 0x24, 0x05, 0xee, 0x03, 0x1d, 0x03, 0xee, 0x03, 0x24, 0x03, 0xf7, 0x01, 0x00, 0x0c, 0x00, 0x20 } },
    { .data = { 0x4c, 0x0f, 0x4c, 0x0d, 0x4c, 0x0b, 0x00, 0x00, 0x51, 0x0f, 0x51, 0x0d, 0x51, 0x0b, 0x4c, 0x01, 0x4c, 0x0f, 0x4c, 0x0d, 0x4f, 0x1f, 0x4f, 0x0d, 0x53, 0x0f, 0x53, 0x0d, 0x4a, 0x0f, 0x4a, 0x0d, 0x4c, 0x0f, 0x4c, 0x0d, 0x4c, 0x0b, 0x00, 0x00, 0x4f, 0x0f, 0x4f, 0x0d, 0x4f, 0x0b, 0x00, 0x00, 0x4a, 0x0f, 0x4a, 0x0d, 0x4a, 0x0b, 0x4f, 0x01, 0x51, 0x0f, 0x51, 0x0d, 0x4a, 0x0f, 0x4a, 0x0d, 0x01, 0x18, 0x00, 0x20 } },
    { .data = { 0x4c, 0x0f, 0x4c, 0x0d, 0x4c, 0x0b, 0x00, 0x00, 0x51, 0x0f, 0x51, 0x0d, 0x51, 0x0b, 0x00, 0x00, 0x4c, 0x0f, 0x4c, 0x0d, 0x4f, 0x1f, 0x4f, 0x0d, 0x53, 0x0f, 0x53, 0x0d, 0x4f, 0x0f, 0x4f, 0x0d, 0x4c, 0x0f, 0x4c, 0x0f, 0x4c, 0x0d, 0x4c, 0x0d, 0x4c, 0x0b, 0x4c, 0x07, 0x4c, 0x01, 0x4c, 0x01, 0x4c, 0x01, 0x4a, 0x01, 0x4a, 0x01, 0x4a, 0x01, 0x51, 0x01, 0x51, 0x01, 0x4a, 0x01, 0x4a, 0x01, 0x00, 0x18, 0x00, 0x20 } },
    { .data = { 0xe4, 0x1f, 0xe4, 0x0f, 0xe4, 0x2d, 0xe4, 0x2b, 0x3a, 0x02, 0x3a, 0x02, 0xd8, 0x2b, 0x3a, 0x02, 0x35, 0x02, 0x35, 0x02, 0xd8, 0x2b, 0x35, 0x02, 0xd8, 0x0b, 0x37, 0x00, 0x37, 0x00, 0x37, 0x00, 0xe2, 0x1f, 0xe2, 0x2f, 0xe2, 0x2d, 0xe2, 0x01, 0xdf, 0x1f, 0xdf, 0x2f, 0xdf, 0x2d, 0xe4, 0x01, 0xe2, 0x1f, 0xe2, 0x2f, 0xe2, 0x2d, 0xc0, 0x01, 0xe7, 0x1f, 0xe7, 0x2f, 0xe7, 0x2d, 0xc0, 0x01, 0x00, 0x0c, 0x00, 0x20 } },
    { .data = { 0xe4, 0x1f, 0xe4, 0x0f, 0xe4, 0x2d, 0xe4, 0x2b, 0x3a, 0x02, 0x3a, 0x02, 0xd8, 0x0b, 0x3a, 0x02, 0x35, 0x02, 0x35, 0x02, 0xd8, 0x0b, 0x35, 0x02, 0xd8, 0x0b, 0xd8, 0x01, 0xd8, 0x01, 0xc0, 0x01, 0xdf, 0x1f, 0xdf, 0x0f, 0xdf, 0x2d, 0xdf, 0x2b, 0xd8, 0x01, 0xc0, 0x01, 0xd8, 0x1b, 0xdb, 0x01, 0xe2, 0x1f, 0xe2, 0x0f, 0xe2, 0x2d, 0xe2, 0x2b, 0x37, 0x22, 0x37, 0x22, 0x37, 0x22, 0x37, 0x20, 0x00, 0x0c, 0x00, 0x20 } },
    { .data = { 0xe4, 0x1f, 0xe4, 0x0f, 0xe4, 0x2f, 0xe4, 0x2f, 0xe4, 0x2d, 0xe4, 0x2b, 0xe4, 0x29, 0xe4, 0x27, 0xe4, 0x25, 0xe4, 0x23, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0xc0, 0x01, 0x2e, 0x00, 0x2e, 0x00, 0x2e, 0x02, 0x2e, 0x02, 0x35, 0x02, 0x35, 0x02, 0x33, 0x12, 0x33, 0x02, 0x2b, 0x02, 0x2b, 0x02, 0x2b, 0x02, 0x2b, 0x00, 0x30, 0x02, 0x30, 0x22, 0x30, 0x22, 0x30, 0x22, 0x00, 0x0c, 0x00, 0x00 } },
    { .data = { 0xcc, 0x26, 0xcc, 0x26, 0xcc, 0x24, 0xcc, 0x24, 0xcc, 0x22, 0xcc, 0x22, 0xcc, 0x22, 0xcc, 0x20, 0xcc, 0x26, 0xcc, 0x26, 0xcc, 0x24, 0xcc, 0x24, 0xcc, 0x22, 0xcc, 0x22, 0xcc, 0x22, 0xcc, 0x20, 0xc7, 0x26, 0xc7, 0x26, 0xc7, 0x24, 0xc7, 0x24, 0xc7, 0x22, 0xc7, 0x22, 0xc7, 0x22, 0xc7, 0x20, 0xca, 0x26, 0xca, 0x26, 0xca, 0x24, 0xca, 0x24, 0xca, 0x22, 0xca, 0x22, 0xca, 0x22, 0xca, 0x20, 0x00, 0x0c, 0x00, 0x20 } },
    { .data = { 0xcc, 0x06, 0xcc, 0x06, 0xcc, 0x04, 0xcc, 0x04, 0xcc, 0x02, 0xcc, 0x02, 0xcc, 0x02, 0x3a, 0x00, 0xcc, 0x06, 0xcc, 0x06, 0xcc, 0x04, 0xcc, 0x04, 0xcc, 0x02, 0xcc, 0x02, 0xcc, 0x02, 0x3f, 0x00, 0xca, 0x06, 0xca, 0x04, 0xd3, 0x06, 0xd3, 0x04, 0xc7, 0x06, 0xc7, 0x04, 0xc7, 0x02, 0xd1, 0x00, 0xca, 0x06, 0xca, 0x04, 0xca, 0x02, 0x3c, 0x00, 0xcf, 0x06, 0xcf, 0x04, 0xcf, 0x02, 0x3a, 0x00, 0x00, 0x0c, 0x00, 0x00 } },
    { .data = { 0xb3, 0x55, 0x9a, 0x51, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x04, 0x00, 0x00 } },
    { .data = { 0xcc, 0x06, 0xcc, 0x06, 0xcc, 0x06, 0xcc, 0x04, 0xcc, 0x04, 0xcc, 0x04, 0xcc, 0x02, 0xcc, 0x02, 0xcc, 0x02, 0xcc, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xca, 0x00, 0xca, 0x00, 0xca, 0x00, 0xca, 0x00, 0xca, 0x16, 0xca, 0x06, 0xc3, 0x14, 0xc3, 0x04, 0x00, 0x0c, 0x00, 0x00 } },
    { .data = { 0xcc, 0x0a, 0xcc, 0x08, 0xcc, 0x06, 0xcc, 0x04, 0xcf, 0x0a, 0xcf, 0x08, 0xcf, 0x06, 0xcf, 0x04, 0xd8, 0x0a, 0xd8, 0x08, 0xd3, 0x0a, 0xd3, 0x08, 0xd8, 0x0a, 0xd3, 0x0a, 0xd6, 0x08, 0xdd, 0x0c, 0xe2, 0x0e, 0xe2, 0x0e, 0xe2, 0x0c, 0xe2, 0x0a, 0xe2, 0x08, 0xe2, 0x04, 0xd3, 0x00, 0xd3, 0x00, 0xd8, 0x00, 0xd8, 0x00, 0xd3, 0x00, 0xd3, 0x00, 0xd6, 0x00, 0xd6, 0x00, 0xdd, 0x00, 0xdd, 0x00, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0xa4, 0x5e, 0xab, 0x5e, 0xb0, 0x5e, 0xa4, 0x5c, 0xab, 0x5c, 0xb0, 0x5c, 0xa4, 0x5a, 0xab, 0x5a, 0xb0, 0x5a, 0xa4, 0x58, 0xab, 0x58, 0xb0, 0x58, 0xa4, 0x56, 0xab, 0x56, 0xb0, 0x56, 0xa4, 0x54, 0xab, 0x54, 0xb0, 0x54, 0xa4, 0x52, 0xab, 0x52, 0xb0, 0x52, 0xa4, 0x50, 0xab, 0x50, 0xb0, 0x50, 0xa4, 0x50, 0xab, 0x50, 0xb0, 0x50, 0xba, 0x50, 0xae, 0x50, 0x80, 0x50, 0x80, 0x50, 0x80, 0x50, 0x00, 0x0c, 0x00, 0x00 } },
    { .data = { 0xaf, 0x5b, 0x01, 0x5e, 0x01, 0x5e, 0xbf, 0x53, 0x01, 0x5e, 0xbf, 0x53, 0xaf, 0x5b, 0x01, 0x5e, 0x01, 0x5e, 0xbf, 0x53, 0x01, 0x5e, 0xbf, 0x53, 0xaf, 0x5b, 0xbf, 0x53, 0x01, 0x5e, 0xbf, 0x53, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x10, 0x00, 0x10 } },
    { .data = { 0x96, 0x0e, 0x96, 0x0e, 0x9f, 0x1e, 0x9f, 0x0e, 0x9f, 0x0e, 0x9f, 0x0e, 0x98, 0x1e, 0x98, 0x0e, 0x93, 0x1e, 0x93, 0x0e, 0x9d, 0x1e, 0x9d, 0x0e, 0x96, 0x1e, 0x96, 0x0e, 0x96, 0x0e, 0x96, 0x0e, 0x9b, 0x1e, 0x9b, 0x0e, 0x9b, 0x0e, 0x9b, 0x0e, 0x00, 0x00, 0x9b, 0x00, 0x00, 0x00, 0x9b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0x64, 0x5f, 0x70, 0x5f, 0x64, 0x59, 0x70, 0x59, 0x5b, 0x5d, 0x67, 0x5d, 0x5f, 0x5f, 0x6b, 0x5f, 0x5f, 0x59, 0x6b, 0x59, 0x5f, 0x57, 0x6b, 0x57, 0x5f, 0x55, 0x6b, 0x55, 0x5f, 0x53, 0x6b, 0x53, 0x5b, 0x5f, 0x67, 0x5f, 0x5b, 0x59, 0x67, 0x59, 0x5b, 0x57, 0x67, 0x57, 0x5d, 0x5f, 0x69, 0x5f, 0x5d, 0x59, 0x69, 0x59, 0x5d, 0x57, 0x69, 0x57, 0x5f, 0x5f, 0x6b, 0x5f, 0x5f, 0x59, 0x6b, 0x59, 0x00, 0x08, 0x00, 0x20 } },
    { .data = { 0x8c, 0x5c, 0x8c, 0x5c, 0x8c, 0x5a, 0x8c, 0x5a, 0x8c, 0x58, 0x8c, 0x58, 0x8c, 0x56, 0x8a, 0x16, 0x8f, 0x5c, 0x8f, 0x5c, 0x8f, 0x5a, 0x8f, 0x5a, 0x8f, 0x58, 0x8f, 0x58, 0x8f, 0x56, 0x96, 0x16, 0x93, 0x5c, 0x93, 0x5c, 0x93, 0x5a, 0x93, 0x5a, 0x93, 0x58, 0x93, 0x58, 0x93, 0x56, 0x93, 0x56, 0x93, 0x54, 0x87, 0x08, 0x96, 0x0e, 0x93, 0x1c, 0x93, 0x0a, 0x93, 0x28, 0x8f, 0x0c, 0x8f, 0x0a, 0x00, 0x20, 0x00, 0x20 } },
    { .data = { 0x87, 0x5e, 0x87, 0x5c, 0x87, 0x5a, 0x87, 0x58, 0x8f, 0x5c, 0x8f, 0x5a, 0x8c, 0x5e, 0x8c, 0x5c, 0x8c, 0x5a, 0x8c, 0x58, 0x8c, 0x56, 0x8c, 0x54, 0x87, 0x5e, 0x87, 0x5c, 0x87, 0x5a, 0x87, 0x58, 0x87, 0x5e, 0x87, 0x5c, 0x87, 0x5a, 0x87, 0x58, 0x8c, 0x5c, 0x8c, 0x5a, 0x91, 0x5e, 0x91, 0x5c, 0x91, 0x5a, 0x91, 0x58, 0x93, 0x5c, 0x93, 0x5a, 0x96, 0x5e, 0x96, 0x5c, 0x96, 0x5a, 0x96, 0x58, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0x5f, 0x0f, 0x6b, 0x0f, 0x5f, 0x09, 0x6b, 0x09, 0x58, 0x0b, 0x64, 0x0b, 0x5b, 0x0f, 0x67, 0x0f, 0x5b, 0x09, 0x67, 0x09, 0x58, 0x0f, 0x64, 0x0f, 0x58, 0x09, 0x64, 0x09, 0x58, 0x07, 0x64, 0x07, 0x5b, 0x0f, 0x67, 0x0f, 0x5b, 0x09, 0x67, 0x09, 0x5d, 0x07, 0x69, 0x07, 0x5d, 0x05, 0x69, 0x05, 0x5f, 0x0f, 0x6b, 0x0f, 0x5f, 0x09, 0x6b, 0x09, 0x5f, 0x07, 0x6b, 0x07, 0x5b, 0x0b, 0x67, 0x0b, 0x00, 0x08, 0x00, 0x20 } },
    { .data = { 0x91, 0x5e, 0x91, 0x5c, 0x91, 0x5a, 0x91, 0x58, 0x93, 0x5c, 0x93, 0x5a, 0x98, 0x5e, 0x98, 0x5c, 0x98, 0x5a, 0x98, 0x58, 0x9d, 0x5c, 0x9d, 0x5a, 0x8f, 0x5c, 0x98, 0x58, 0x93, 0x5e, 0x96, 0x5a, 0x8f, 0x5e, 0x8f, 0x5c, 0x8f, 0x5a, 0x8f, 0x58, 0x91, 0x5c, 0x91, 0x5a, 0x96, 0x5e, 0x96, 0x5c, 0x96, 0x5a, 0x96, 0x58, 0x9b, 0x5c, 0x9b, 0x5a, 0xa2, 0x5e, 0x9f, 0x58, 0x98, 0x5c, 0x93, 0x56, 0x00, 0x10, 0x00, 0x20 } },
    { .data = { 0x01, 0x5e, 0xaf, 0x5b, 0x01, 0x5e, 0xbf, 0x53, 0xaf, 0x5b, 0xbf, 0x53, 0x01, 0x5e, 0xbf, 0x53, 0x01, 0x5e, 0xbf, 0x53, 0xaf, 0x5b, 0x01, 0x5e, 0xaf, 0x5b, 0xbf, 0x53, 0x01, 0x5e, 0xbf, 0x53, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x10, 0x00, 0x10 } },
    { .data = { 0x01, 0x5e, 0x01, 0x5e, 0x01, 0x5e, 0xbf, 0x53, 0xaf, 0x5b, 0xbf, 0x53, 0xbf, 0x53, 0x01, 0x5e, 0x01, 0x5e, 0xbf, 0x53, 0x01, 0x5e, 0xbf, 0x53, 0xaf, 0x5b, 0xbf, 0x53, 0xaf, 0x5b, 0xbf, 0x53, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x50, 0x00, 0x10, 0x00, 0x10 } },
    { .data = { 0x29, 0x08, 0x29, 0x08, 0x29, 0x06, 0x2b, 0x16, 0x29, 0x44, 0x2b, 0x14, 0x29, 0x42, 0x2b, 0x12, 0x33, 0x48, 0x30, 0x18, 0x2e, 0x48, 0x2e, 0x06, 0x30, 0x48, 0x30, 0x06, 0x2b, 0x18, 0x2b, 0x06, 0x2e, 0x48, 0x2e, 0x08, 0x2e, 0x06, 0x30, 0x16, 0x2e, 0x44, 0x30, 0x14, 0x2e, 0x44, 0x30, 0x14, 0x2b, 0x48, 0x2e, 0x18, 0x2b, 0x46, 0x2e, 0x14, 0x2b, 0x48, 0x2b, 0x08, 0x29, 0x16, 0x29, 0x24, 0x00, 0x20, 0x00, 0x00 } },
    { .data = { 0x64, 0x53, 0x64, 0x53, 0x64, 0x55, 0x64, 0x55, 0x64, 0x57, 0x64, 0x57, 0x64, 0x59, 0x64, 0x59, 0x64, 0x5b, 0x64, 0x5b, 0x64, 0x5d, 0x64, 0x5d, 0x64, 0x5f, 0x40, 0x51, 0x64, 0x5f, 0x40, 0x51, 0x64, 0x5d, 0x40, 0x51, 0x64, 0x5d, 0x40, 0x51, 0x64, 0x5b, 0x40, 0x51, 0x64, 0x5b, 0x40, 0x51, 0x64, 0x59, 0x40, 0x51, 0x64, 0x57, 0x40, 0x51, 0x64, 0x55, 0x40, 0x51, 0x64, 0x53, 0x40, 0x51, 0x00, 0x08, 0x00, 0x20 } },
    { .data = { 0x5f, 0x53, 0x5f, 0x53, 0x5f, 0x55, 0x5f, 0x55, 0x5f, 0x57, 0x5f, 0x57, 0x5f, 0x59, 0x5f, 0x59, 0x5f, 0x5b, 0x5f, 0x5b, 0x5f, 0x5d, 0x5f, 0x5d, 0x5f, 0x5f, 0x00, 0x50, 0x5f, 0x5f, 0x00, 0x50, 0x5f, 0x5d, 0x00, 0x50, 0x5f, 0x5d, 0x00, 0x50, 0x5f, 0x5b, 0x00, 0x50, 0x5f, 0x5b, 0x00, 0x50, 0x5f, 0x59, 0x00, 0x50, 0x5f, 0x57, 0x00, 0x50, 0x5f, 0x55, 0x00, 0x50, 0x5f, 0x53, 0x00, 0x50, 0x00, 0x08, 0x00, 0x20 } },
    { .data = { 0xc3, 0x07, 0xc5, 0x17, 0xc7, 0x19, 0xcc, 0x19, 0xd3, 0x1b, 0xdb, 0x1d, 0xe4, 0x0e, 0xf0, 0x1e, 0x67, 0x0f, 0x6e, 0x1f, 0xe4, 0x0e, 0xf0, 0x1e, 0x67, 0x0f, 0x6e, 0x1f, 0xe4, 0x0c, 0xf0, 0x1c, 0x67, 0x0d, 0x6e, 0x1d, 0xe4, 0x0a, 0xf0, 0x1a, 0x67, 0x0b, 0x6e, 0x1b, 0xe4, 0x08, 0xf0, 0x18, 0x67, 0x09, 0x6e, 0x19, 0xe4, 0x06, 0xf0, 0x16, 0x67, 0x05, 0x6e, 0x15, 0xe4, 0x02, 0xf0, 0x12, 0x00, 0x05, 0x00, 0x00 } },
    { .data = { 0x8c, 0x5e, 0x8c, 0x5c, 0x8c, 0x5a, 0x8c, 0x58, 0x8c, 0x56, 0x8a, 0x5c, 0x8a, 0x5a, 0x8a, 0x58, 0x8f, 0x5e, 0x8f, 0x5c, 0x8f, 0x5a, 0x8f, 0x58, 0x8f, 0x56, 0x8c, 0x5c, 0x8c, 0x5a, 0x8c, 0x58, 0x8c, 0x5e, 0x8c, 0x5c, 0x8c, 0x5a, 0x8c, 0x58, 0x8c, 0x56, 0x8a, 0x5c, 0x8a, 0x5a, 0x8a, 0x58, 0x8f, 0x5e, 0x8f, 0x5c, 0x8f, 0x5a, 0x8f, 0x58, 0x8f, 0x56, 0x91, 0x5c, 0x91, 0x5a, 0x91, 0x58, 0x00, 0x20, 0x00, 0x20 } },
    { .data = { 0x93, 0x5e, 0x93, 0x5c, 0x93, 0x5a, 0x93, 0x58, 0x93, 0x56, 0x91, 0x5c, 0x91, 0x5a, 0x91, 0x58, 0x96, 0x5e, 0x96, 0x5c, 0x96, 0x5a, 0x96, 0x58, 0x96, 0x56, 0x93, 0x5c, 0x93, 0x5a, 0x93, 0x58, 0x93, 0x5e, 0x93, 0x5c, 0x93, 0x5a, 0x93, 0x58, 0x93, 0x56, 0x8f, 0x5c, 0x8f, 0x5a, 0x8f, 0x58, 0x8c, 0x0a, 0x91, 0x16, 0x96, 0x5c, 0x8f, 0x58, 0x96, 0x2e, 0x96, 0x2a, 0x8c, 0x0e, 0x8c, 0x5a, 0x00, 0x20, 0x00, 0x00 } },
    { .data = { 0xdf, 0x06, 0xeb, 0x06, 0x62, 0x07, 0x69, 0x07, 0xdf, 0x04, 0xeb, 0x04, 0x62, 0x05, 0x69, 0x05, 0xdf, 0x02, 0xeb, 0x02, 0x62, 0x03, 0x69, 0x03, 0xdf, 0x00, 0xeb, 0x00, 0x62, 0x01, 0x69, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00 } },
    { .data = { 0xe9, 0x5a, 0xc0, 0x00, 0xe9, 0x58, 0xf0, 0x0e, 0xf0, 0x0c, 0xf0, 0x5a, 0xd3, 0x50, 0xe4, 0x00, 0xe4, 0x50, 0xc0, 0x00, 0xd3, 0x50, 0xe4, 0x00, 0xe4, 0x50, 0xc0, 0x00, 0xc0, 0x00, 0xe4, 0x00, 0xe4, 0x50, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0xc0, 0x00, 0x00, 0x0b, 0x00, 0x00 } },
    { .data = { 0x7c, 0x5f, 0x7c, 0x59, 0x7c, 0x57, 0x7c, 0x55, 0x7c, 0x53, 0x7c, 0x53, 0x77, 0x5b, 0x77, 0x59, 0x7a, 0x5f, 0x7a, 0x5b, 0x7a, 0x59, 0x7a, 0x57, 0x7a, 0x55, 0x7a, 0x55, 0x7a, 0x53, 0x7a, 0x53, 0x75, 0x5f, 0x75, 0x5b, 0x75, 0x59, 0x75, 0x59, 0x75, 0x57, 0x75, 0x57, 0x75, 0x55, 0x75, 0x55, 0x75, 0x53, 0x75, 0x53, 0x73, 0x5f, 0x73, 0x5b, 0x73, 0x59, 0x73, 0x57, 0x73, 0x55, 0x73, 0x53, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0x75, 0x5f, 0x75, 0x5b, 0x75, 0x59, 0x75, 0x57, 0x75, 0x55, 0x75, 0x55, 0x75, 0x53, 0x75, 0x53, 0x77, 0x5b, 0x77, 0x57, 0x73, 0x5f, 0x73, 0x5b, 0x73, 0x59, 0x73, 0x57, 0x73, 0x55, 0x73, 0x55, 0x7a, 0x5f, 0x7a, 0x59, 0x7a, 0x57, 0x7a, 0x55, 0x7a, 0x53, 0x7a, 0x53, 0x73, 0x5f, 0x73, 0x5b, 0x73, 0x59, 0x73, 0x59, 0x73, 0x57, 0x73, 0x57, 0x73, 0x55, 0x73, 0x55, 0x73, 0x53, 0x73, 0x53, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0x0c, 0x0c, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x02, 0x0c, 0x00, 0x0c, 0x0c, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x02, 0x0f, 0x00, 0x11, 0x0c, 0x11, 0x06, 0x11, 0x0a, 0x11, 0x06, 0x11, 0x02, 0x11, 0x00, 0x0a, 0x0c, 0x0a, 0x06, 0x0a, 0x0a, 0x0a, 0x06, 0x0a, 0x0a, 0x0a, 0x06, 0x0a, 0x0a, 0x0a, 0x06, 0x0a, 0x02, 0x00, 0x00, 0x00, 0x10, 0x00, 0x20 } },
    { .data = { 0x05, 0x0c, 0x05, 0x06, 0x05, 0x0a, 0x05, 0x06, 0x05, 0x02, 0x05, 0x00, 0x07, 0x0c, 0x07, 0x06, 0x07, 0x0a, 0x07, 0x06, 0x07, 0x02, 0x00, 0x00, 0x0f, 0x0c, 0x0f, 0x06, 0x0f, 0x02, 0x00, 0x00, 0x0c, 0x0c, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x0a, 0x0c, 0x06, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0c, 0x0c, 0x06, 0x0c, 0x02, 0x0c, 0x00, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0x83, 0x55, 0xa4, 0x53, 0x80, 0x51, 0x83, 0x53, 0xa4, 0x55, 0x9b, 0x53, 0xa2, 0x55, 0x83, 0x53, 0x80, 0x51, 0x83, 0x53, 0x91, 0x55, 0xb3, 0x53, 0xa2, 0x55, 0x80, 0x51, 0x9d, 0x55, 0x8a, 0x53, 0xb7, 0x55, 0x98, 0x53, 0xae, 0x55, 0x9d, 0x53, 0x80, 0x51, 0xb7, 0x53, 0xb7, 0x55, 0x98, 0x53, 0xae, 0x55, 0x9d, 0x53, 0x91, 0x55, 0x83, 0x53, 0x80, 0x51, 0x83, 0x53, 0xa4, 0x55, 0x9d, 0x53, 0x00, 0x10, 0x00, 0x00 } },
    { .data = { 0xb2, 0x03, 0xb2, 0x03, 0xb2, 0x03, 0xb2, 0x03, 0xb1, 0x03, 0xb1, 0x03, 0xb0, 0x03, 0xae, 0x03, 0xaa, 0x03, 0xa5, 0x03, 0x9b, 0x03, 0x93, 0x03, 0x8f, 0x03, 0x8d, 0x03, 0x8c, 0x03, 0x8c, 0x03, 0x8c, 0x03, 0x8c, 0x03, 0x8c, 0x03, 0x8f, 0x03, 0x94, 0x03, 0x9d, 0x03, 0xa4, 0x03, 0xaa, 0x03, 0xae, 0x03, 0xb0, 0x03, 0xb1, 0x03, 0xb3, 0x03, 0xb3, 0x03, 0xb4, 0x03, 0xb4, 0x03, 0xb4, 0x03, 0x00, 0x10, 0x00, 0x20 } },
    { .data = { 0xb0, 0x58, 0xb0, 0x50, 0xb0, 0x56, 0xb3, 0x54, 0xab, 0x56, 0xb0, 0x50, 0xb0, 0x54, 0xb0, 0x50, 0xb0, 0x50, 0xb0, 0x54, 0xb0, 0x50, 0xb0, 0x50, 0xb0, 0x52, 0xb0, 0x50, 0xb0, 0x50, 0xb0, 0x52, 0xab, 0x58, 0xab, 0x50, 0xab, 0x56, 0xa7, 0x54, 0xa9, 0x56, 0xab, 0x50, 0xab, 0x54, 0xab, 0x50, 0xab, 0x50, 0xab, 0x54, 0xab, 0x50, 0xab, 0x50, 0xab, 0x52, 0xab, 0x50, 0xab, 0x50, 0xab, 0x52, 0x00, 0x40, 0x00, 0x00 } },
    { .data = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00 } },
};

enum
{
    INST_TRIANGLE   = 0, // Triangle signal
    INST_TILTED_SAW = 1, // Slanted triangle
    INST_SAW        = 2, // Sawtooth
    INST_SQUARE     = 3, // Square signal
    INST_PULSE      = 4, // Asymmetric square signal
    INST_ORGAN      = 5, // Some triangle stuff again
    INST_NOISE      = 6,
    INST_PHASER     = 7,
};

static float lastadvance;
static float sample;
static float lsample;

static float getWaveformSample(int instrument, float advance)
{
    //const from picolove:
    //local function note_to_hz(note)
    //  return 440 * 2 ^ ((note - 33) / 12)
    //end
    //local tscale = note_to_hz(63) / __sample_rate
    const float tscale = 0.11288053831187f;

    float t = fmod(advance, 1.f);
    float ret = 0.f;

    switch (instrument)
    {
        case INST_TRIANGLE:
            return 0.5f * (fabs(4.f * t - 2.0f) - 1.0f);
        case INST_TILTED_SAW:
        {
            static float const a = 0.9f;
            ret = t < a ? 2.f * t / a - 1.f
                        : 2.f * (1.f - t) / (1.f - a) - 1.f;
            return ret * 0.5f;
        }
        case INST_SAW:
            return 0.653f * (t < 0.5f ? t : t - 1.f);
        case INST_SQUARE:
            return t < 0.5f ? 0.25f : -0.25f;
        case INST_PULSE:
            return t < 1.f / 3 ? 0.25f : -0.25f;
        case INST_ORGAN:
            ret = t < 0.5f ? 3.f - fabs(24.f * t - 6.f)
                           : 1.f - fabs(16.f * t - 12.f);
            return ret / 9.f;
        case INST_NOISE:
        {
            float scale = (advance - lastadvance) / tscale;
            lsample = sample;
            sample = (lsample + scale * (((float)rand() / (float)RAND_MAX) * 2.0f - 1.0f)) / (1.0f + scale);
            lastadvance = advance;
            float endval = fmin(fmax((lsample + sample) * 4.0f / 3.0f * (1.75f - scale), -1.0f), 1.0f) * 0.2f;
            return endval;
        }
        case INST_PHASER:
        {
            float k = fabs(2.f * fmod(advance / 128.f, 1.f) - 1.f);
            float u = fmod(t + 0.5f * k, 1.0f);
            ret = fabs(4.f * u - 2.f) - fabs(8.f * t - 4.f);
            return ret / 6.f;
        }
    }

    return 0.0f;
}

static float getSampleForNote(struct noteChannel *channel, struct sfxChannel *parentChannel, uint8_t prev_note[2], float freqShift, bool forceRemainder) {
    float offset = parentChannel->offset;
    int const fx = (channel->note[1] & 0b01110000) >> 4;
    uint8_t key = channel->note[0] & 0b00111111;
    float volume = ((channel->note[1] & 0b00001110) >> 1) / 7.f;
    float freq = key_to_freq(key);

    struct sfx *sfx = &mem_sfx[parentChannel->sfxId];

    // Speed must be 1—255 otherwise the SFX is invalid
    int const speed = max(1, (int)sfx->speed);
    float const offset_per_second = (float)(SAMPLE_RATE) / (183.f * speed);
    int const note_idx = (int)floor(offset);

    // previous note effectively goes beyond offset fmod 1 when in crossfade
    float tmod= 0;
    if (forceRemainder) tmod = 1.0f;
    tmod += fmod(offset, 1.f);
    // Apply effect, if any
    switch (fx)
    {
        case FX_NO_EFFECT:
            break;
        case FX_SLIDE:
        {
            // From the documentation: “Slide to the next note and volume”,
            // but it’s actually _from_ the _prev_ note and volume.
            freq = lerp(key_to_freq(prev_note[0] & 0b00111111), freq, tmod);
            if ((prev_note[1] & 0b00001110) > 0)
                volume = lerp( ((prev_note[1] & 0b00001110) >> 1) / 7.0f, volume, tmod);
            break;
        }
        case FX_VIBRATO:
        {
            // 7.5f and 0.25f were found empirically by matching
            // frequency graphs of PICO-8 instruments.
            float t = fabs(fmod(7.5f * tmod / offset_per_second, 1.0f) - 0.5f) - 0.25f;
            // Vibrato half a semi-tone, so multiply by pow(2,1/12)
            freq = lerp(freq, freq * 1.059463094359f, t);
            break;
        }
        case FX_DROP:
            freq *= 1.f - fmod(offset, 1.f);
            break;
        case FX_FADE_IN:
            volume *= fmin(1.f, tmod);
            break;
        case FX_FADE_OUT:
            volume *= fmax(0.0f, 1.f - tmod);
            break;
        case FX_ARP_FAST:
        case FX_ARP_SLOW:
        {
            // From the documentation:
            // “6 arpeggio fast  //  Iterate over groups of 4 notes at speed of 4
            //  7 arpeggio slow  //  Iterate over groups of 4 notes at speed of 8”
            // “If the SFX speed is <= 8, arpeggio speeds are halved to 2, 4”
            int const m = (speed <= 8 ? 32 : 16) / (fx == FX_ARP_FAST ? 4 : 8);
            int const n = (int)(m * 7.5f * offset / offset_per_second);
            int const arp_note = (note_idx & ~3) | (n & 3);
            freq = key_to_freq(sfx->notes[arp_note][0] & 0b00111111);
            break;
        }
    }
    freq*=freqShift;
    
    float waveform;

    waveform = volume * getWaveformSample(((channel->note[1] & 0b00000001) << 2) + ((channel->note[0] & 0b11000000) >> 6), channel->phi);

    channel->phi = channel->phi + freq / SAMPLE_RATE;
    return waveform;
}

static float getSampleForSfx(struct sfxChannel *channel, float freqShift) {
    if (channel->sfxId < 0 || channel->sfxId > 63) {
        //no (valid) sfx here. return silence
        return 0;
    }
    struct sfx const *sfx = &mem_sfx[channel->sfxId];

    // Speed must be 1—255 otherwise the SFX is invalid
    int const speed = max(1, (int)sfx->speed);

    // PICO-8 exports instruments as 22050 Hz WAV files with 183 samples
    // per speed unit per note, so this is how much we should advance
    float const offset_per_second = (float)SAMPLE_RATE / (183.f * speed);
    float const offset_per_sample = offset_per_second / SAMPLE_RATE;
    float next_offset = channel->offset + offset_per_sample;

    // Handle SFX loops. From the documentation: “Looping is turned
    // off when the start index >= end index”.
    float const loop_range = (float)(sfx->loopRangeEnd - sfx->loopRangeStart);
    if (loop_range > 0.f && next_offset >= sfx->loopRangeStart && channel->can_loop) {
        next_offset = fmod(next_offset - sfx->loopRangeStart, loop_range)
                    + sfx->loopRangeStart;
    }

    int const note_idx = (int)floor(channel->offset);
    channel->current_note.note[0] = sfx->notes[note_idx][0];
    channel->current_note.note[1] = sfx->notes[note_idx][1];
    int const next_note_idx = (int)floor(next_offset);

    // tiniest fade in/out to fix popping
    // the real version uses a crossfade it looks like
    // 25 samples was estimated from looking at pcm out from pico-8
    float const fade_duration = offset_per_sample * 25;
    float offset_part = fmod(channel->offset, 1.f);
    float crossfade = 0;
    if (offset_part < fade_duration) {
      crossfade = (fade_duration-offset_part)/fade_duration;
    }
    

    // it seems we're not allowed to play custom instruments
    // recursively inside a custom instrument.
    float waveform = getSampleForNote(&(channel->current_note), channel, channel->prev_note.note, freqShift, false);
    if (crossfade > 0) {
      waveform *= (1.0f-crossfade);
      uint8_t dummyNote[2];
      waveform+= crossfade * getSampleForNote(&(channel->prev_note), channel, dummyNote, freqShift, true);
    }
    uint8_t len = sfx->loopRangeEnd == 0 ? 32 : sfx->loopRangeEnd;
    bool lastNote = note_idx == len - 1;
    if (lastNote && 1.0f - offset_part < fade_duration) {
      waveform *= (fade_duration - 1.0f + offset_part)/fade_duration;
    }

    // Apply master music volume from fade in/out
    // FIXME: check whether this should be done after distortion
    if (channel->is_music) {
        waveform *= _audioState._musicChannel.volume;
    }

    channel->offset = next_offset;

    if (next_offset >= 32.f){
        channel->sfxId = -1;
    }
    else if (next_note_idx != note_idx){
        channel->prev_note = channel->current_note; //sfx.notes[note_idx].getKey();
        channel->current_note.note[0] = sfx->notes[next_note_idx][0];
        channel->current_note.note[1] = sfx->notes[next_note_idx][1];
        channel->current_note.phi = channel->prev_note.phi;
    }
    return waveform;

}

static void set_music_pattern(int pattern) {
    _audioState._musicChannel.pattern = pattern;
    _audioState._musicChannel.offset = 0;

    //array to access song's channels. may be better to have this part of the struct?
    uint8_t channels[] = {
        mem_songs[pattern][0] & 0b01111111,
        mem_songs[pattern][1] & 0b01111111,
        mem_songs[pattern][2] & 0b01111111,
        mem_songs[pattern][3] & 0b01111111,
    };

    uint16_t shortest = 32 * 255; // longest sfx possible
    bool foundNonLooping = false;
    // Find music speed; it’s the speed of the fastest sfx
    // While we are looping through this, find the lowest *valid* sfx length
    _audioState._musicChannel.master = -1;
    _audioState._musicChannel.speed = 0;
    _audioState._musicChannel.length = 32; //as far as i can tell, there is no way to make an sfx longer than 32.
    for (int i = 0; i < 4; ++i)
    {
        uint8_t n = channels[i];

        if (n & 0x40)
            continue;

        // we ignore looping length if we have non-looping channel
        struct sfx *sfx = &mem_sfx[n & 0x3f];
        bool looping = sfx->loopRangeStart < sfx->loopRangeEnd;
        bool firstNonLooping = !looping && !foundNonLooping;
        if (!looping) {
            foundNonLooping=true;
        }

        uint8_t length = 32;
        if(sfx->loopRangeStart != 0 && sfx->loopRangeEnd == 0)
        {
            length= sfx->loopRangeStart;
        }

        uint16_t timeLength = length * max(1, (int)sfx->speed);;

        if ((!looping || !foundNonLooping) && (firstNonLooping || _audioState._musicChannel.master == -1 || shortest > timeLength))
        {
            shortest = timeLength;
            _audioState._musicChannel.master = i;
            _audioState._musicChannel.speed = max(1, (int)sfx->speed);
            _audioState._musicChannel.length = length;
        }
    }

    // Play music sfx on active channels
    for (int i = 0; i < 4; ++i)
    {
        if (((1 << i) & _audioState._musicChannel.mask) == 0)
            continue;

        uint8_t n = channels[i];
        if (n & 0x40) {
            _audioState._sfxChannels[i].sfxId = -1;
            continue;
        }

        _audioState._sfxChannels[i].sfxId = n;
        _audioState._sfxChannels[i].offset = 0.f;
        _audioState._sfxChannels[i].current_note.phi = 0.f;
        // if the master channel loops we'll never finish
        _audioState._sfxChannels[i].can_loop = i != _audioState._musicChannel.master;
        _audioState._sfxChannels[i].is_music = true;
        _audioState._sfxChannels[i].prev_note.note[0] = (_audioState._sfxChannels[i].prev_note.note[0] & 0b11000000) | 24;
        _audioState._sfxChannels[i].prev_note.note[1] = _audioState._sfxChannels[i].prev_note.note[1] & 0b11110001;
    }
}

static int16_t getSampleForChannel(int channel){
    int16_t sample = 0;

    // Advance music using the master channel
    if (channel == _audioState._musicChannel.master && _audioState._musicChannel.pattern != -1)
    {
        float const offset_per_second = (float)(SAMPLE_RATE) / (183.f * _audioState._musicChannel.speed);
        float const offset_per_sample = offset_per_second / SAMPLE_RATE;
        _audioState._musicChannel.offset += offset_per_sample;
        _audioState._musicChannel.volume += _audioState._musicChannel.volume_step / SAMPLE_RATE;
        _audioState._musicChannel.volume = clamp(_audioState._musicChannel.volume, 0.f, 1.f);

        if (_audioState._musicChannel.volume_step < 0 && _audioState._musicChannel.volume <= 0)
        {
            // Fade out is finished, stop playing the current song
            for (int i = 0; i < 4; ++i) {
                if (_audioState._sfxChannels[i].is_music) {
                    _audioState._sfxChannels[i].sfxId = -1;
                }
            }
            _audioState._musicChannel.pattern = -1;
        }
        else if (_audioState._musicChannel.offset >= _audioState._musicChannel.length)
        {
            int16_t next_pattern = _audioState._musicChannel.pattern + 1;
            int16_t next_count = _audioState._musicChannel.count + 1;
            //todo: pull out these flags, get memory storage correct as well
            if (mem_songs[_audioState._musicChannel.pattern][2] & 0b10000000) //stop part of the loop flag
            {
                next_pattern = -1;
                next_count = _audioState._musicChannel.count;
            }
            else if (mem_songs[_audioState._musicChannel.pattern][1] & 0b10000000) {
                while (--next_pattern > 0 && !(mem_songs[next_pattern][0] & 0b10000000))
                    ;
            }

            _audioState._musicChannel.count = next_count;
            set_music_pattern(next_pattern);
        }
    }

    sample = (int16_t) (32767.99f * getSampleForSfx(&(_audioState._sfxChannels[channel]), 1.0f));

    return sample;
}

/* public functions */

void celeste_init_audio() {
    for(int i = 0; i < 4; i++) {
        _audioState._sfxChannels[i].sfxId = -1;
        _audioState._sfxChannels[i].offset = 0;
        _audioState._sfxChannels[i].current_note.phi = 0;
        _audioState._sfxChannels[i].can_loop = true;
        _audioState._sfxChannels[i].is_music = false;
        _audioState._sfxChannels[i].prev_note.note[0] = 0;
        _audioState._sfxChannels[i].prev_note.note[1] = 0;
    }
    _audioState._musicChannel.count = 0;
    _audioState._musicChannel.pattern = -1;
    _audioState._musicChannel.master = -1;
    _audioState._musicChannel.mask = 0xf;
    _audioState._musicChannel.speed = 0;
    _audioState._musicChannel.volume = 0.f;
    _audioState._musicChannel.volume_step = 0.f;
    _audioState._musicChannel.offset = 0.f;
}

void celeste_api_sfx(int sfx, int channel, int offset) {

    if (sfx < -2 || sfx > 63 || channel < -2 || channel > 3 || offset > 31) {
        return;
    }

    //CHANNEL -2: to stop the given sound from playing on any channel
    if (channel == -2) {
        for(int i = 0; i < 4; i++) {
            if (_audioState._sfxChannels[i].sfxId == sfx) {
                _audioState._sfxChannels[i].sfxId = -1;
            }
        }
        return;
    }

    if (sfx == -1)
    {
        // Stop playing the current channel
        if (channel != -1) {
            _audioState._sfxChannels[channel].sfxId = -1;
        }
    }
    else if (sfx == -2)
    {
        // Stop looping the current channel
        if (channel != -1) {
            _audioState._sfxChannels[channel].can_loop = false;
        }
    }
    else
    {
        // Find the first available channel: either a channel that plays
        // nothing, or a channel that is already playing this sample (in
        // this case PICO-8 decides to forcibly reuse that channel, which
        // is reasonable)
        if (channel == -1)
        {
            for (int i = 0; i < 4; ++i)
                if (_audioState._sfxChannels[i].sfxId == -1 ||
                    _audioState._sfxChannels[i].sfxId == sfx)
                {
                    channel = i;
                    break;
                }
        }

        // If still no channel found, the PICO-8 strategy seems to be to
        // stop the sample with the lowest ID currently playing
        if (channel == -1)
        {
            for (int i = 0; i < 4; ++i) {
               if (channel == -1 || _audioState._sfxChannels[i].sfxId < _audioState._sfxChannels[channel].sfxId) {
                   channel = i;
               }
            }
        }

        // Stop any channel playing the same sfx
        for (int i = 0; i < 4; ++i) {
            if (_audioState._sfxChannels[i].sfxId == sfx) {
                _audioState._sfxChannels[i].sfxId = -1;
            }
        }

        // Play this sound!
        _audioState._sfxChannels[channel].sfxId = sfx;
        _audioState._sfxChannels[channel].offset = fmax(0.0f, (float)offset);
        _audioState._sfxChannels[channel].current_note.phi = 0.f;
        _audioState._sfxChannels[channel].can_loop = true;
        _audioState._sfxChannels[channel].is_music = false;
        // Playing an instrument starting with the note C-2 and the
        // slide effect causes no noticeable pitch variation in PICO-8,
        // so I assume this is the default value for “previous key”.
        _audioState._sfxChannels[channel].prev_note.note[0] = (_audioState._sfxChannels[channel].prev_note.note[0] & 0b11000000) | 24;

        // There is no default value for “previous volume”.
        _audioState._sfxChannels[channel].prev_note.note[1] = _audioState._sfxChannels[channel].prev_note.note[1] & 0b11110001;
    }      
}

void celeste_api_music(int pattern, int16_t fade_len, int16_t mask) {
    if (pattern < -1 || pattern > 63) {
        return;
    }

    if (pattern == -1)
    {
        // Music will stop when fade out is finished
        _audioState._musicChannel.volume_step = fade_len <= 0 ? -FLT_MAX
                                  : -_audioState._musicChannel.volume * (1000.f / fade_len);
        return;
    }

    _audioState._musicChannel.count = 0;
    _audioState._musicChannel.mask = mask ? mask & 0xf : 0xf;

    _audioState._musicChannel.volume = 1.f;
    _audioState._musicChannel.volume_step = 0.f;
    if (fade_len > 0)
    {
        _audioState._musicChannel.volume = 0.f;
        _audioState._musicChannel.volume_step = 1000.f / fade_len;
    }

    set_music_pattern(pattern);
}

void celeste_fill_audio_buffer(void *audioBuffer, size_t offset, size_t size) {
    if (audioBuffer == NULL) {
        return;
    }

    int16_t *buffer = (int16_t *)audioBuffer;

    for (size_t i = 0; i < size; ++i){
        int32_t sample = 0;

        for (int c = 0; c < 4; ++c) {
            sample += getSampleForChannel(c);
        }

        if (sample > 0x7fff) sample = 0x7fff; else if (sample < -0x8000) sample = -0x8000;

        buffer[i] = sample;
    }
}
